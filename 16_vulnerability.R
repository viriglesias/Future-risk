pacman::p_load(tidyverse, ggtext, tools, foreach, scico, scales, ggthemes, ggpubr, Hmisc, sf, classInt, biscale, cowplot)

if(file.exists("/Users/viig7608/Desktop/Fire risk/Data/Processed/census_tracts_with_risk.shp")){
  x <- st_read("/Users/viig7608/Desktop/Fire risk/Data/Processed/census_tracts_with_risk.shp")
}else {
eco_shp <- st_read('Data/Raw/us_eco_l4_state_boundaries') %>%
  mutate(id = paste(US_L4CODE, Shape_Area, sep = '_'))
combo <- read.csv('/Users/viig7608/Desktop/Fire risk/Data/Processed/risk.csv')

past <- filter(combo, Year>2010 & Year<2021) %>% 
  group_by(id) %>% 
  summarise(past = sum(str_destroyed, na.rm = T))

fut <- filter(combo, Year>2050) %>% 
  group_by(id, type) %>% 
  summarise(fut_risk = sum(str_destroyed, na.rm = T))

fut_wide <- fut %>% 
  pivot_wider(names_from = type, values_from = fut_risk)
names(fut_wide)[2:4] <- c('cnrm', 'had', 'mri')
full <- left_join(past, fut_wide)

eco_risk <- left_join(eco_shp, full)

eco_risk <- eco_risk %>% 
  mutate(past = ifelse(is.na(past), 0, past),
         change_cnrm = ifelse(is.infinite(cnrm/past), 1.1,
                              ifelse(is.nan(cnrm/past), 1, cnrm/past)),
         change_had = ifelse(is.infinite(had/past), 1.1,
                             ifelse(is.nan(had/past), 1, had/past)),
         change_mri = ifelse(is.infinite(mri/past), 1.1,
                             ifelse(is.nan(mri/past), 1, mri/past)))

x <- st_read('/Users/viig7608/Desktop/Fire risk/Data/Raw/2.0-shapefile-codebook/usa')
x <- filter(x, !SF %in% c("Alaska", "Hawaii",   "Puerto Rico" ,"American Samoa","Guam" ,"Northern Mariana Islands", "Virgin Islands"))
x <- x %>% 
  st_transform(st_crs(eco_risk))
census_tcts <- x[,1]
  
# Perform intersection to find overlapping areas
intersection <- st_intersection(eco_risk, census_tcts)

# Calculate area of intersection
intersection$area <- st_area(intersection)

# Compute area-weighted mean risk per census tract
weighted_risk <- intersection %>%
  st_drop_geometry() %>% 
  mutate(region = str_extract_all(L1_KEY, "\\d+"))
weighted_risk <- weighted_risk %>% 
  mutate(region = ifelse(region %in% c(6, 7, 10, 11, 12, 13), 'West', 
                         ifelse(region %in% c(8, 15, 5), 'East', 
                                ifelse(region %in% c(9), 'Central', 'Double-check')))) 
weighted_risk <- weighted_risk %>% 
  group_by(region, GEOID10) %>%
  summarise(past = sum(past * as.numeric(area), na.rm = T) / sum(as.numeric(area)),
            cnrm = sum(cnrm * as.numeric(area), na.rm = T) / sum(as.numeric(area)),
            had = sum(had * as.numeric(area), na.rm = T) / sum(as.numeric(area)),
            mri = sum(mri * as.numeric(area), na.rm = T) / sum(as.numeric(area)),
            change_cnrm = sum(change_cnrm * as.numeric(area), na.rm = T) / sum(as.numeric(area)),
            change_had = sum(change_had * as.numeric(area), na.rm = T) / sum(as.numeric(area)),
            change_mri = sum(change_mri * as.numeric(area), na.rm = T) / sum(as.numeric(area)))

# Join back to the census tract dataset
x <- left_join(x, weighted_risk, by = 'GEOID10')
# # # Save or plot results
st_write(x, "/Users/viig7608/Desktop/Fire risk/Data/Processed/census_tracts_with_risk.shp")  
}

#Figures
eco_risk <- st_read('Data/Raw/us_eco_l4_state_boundaries') %>%
  mutate(id = paste(US_L4CODE, Shape_Area, sep = '_'))
regions <- eco_risk %>% 
  mutate(region = str_extract_all(L1_KEY, "\\d+"))
regions <- regions %>% 
  mutate(region = ifelse(region %in% c(6, 7, 10, 11, 12, 13), 'West', 
                         ifelse(region %in% c(8, 15, 5), 'East', 
                                ifelse(region %in% c(9), 'Central', 'Double-check')))) 
regions <- regions %>% 
  group_by(region) %>% 
  summarise(geometry = st_union(geometry))

n_breaks <- 3  # Define the number of quantiles
x$HBF_PFS_cat <- cut(x$HBF_PFS, breaks = quantile(x$HBF_PFS, probs = seq(0, 1, length.out = n_breaks + 1), na.rm = TRUE), include.lowest = TRUE, labels = FALSE)
x$P200_I_PFS_cat <- cut(x$P200_I, breaks = quantile(x$P200_I, probs = seq(0, 1, length.out = n_breaks + 1), na.rm = TRUE), include.lowest = TRUE, labels = FALSE)
x$LIF_PFS_cat <- cut(x$LIF_PFS, breaks = quantile(x$LIF_PFS, probs = seq(0, 1, length.out = n_breaks + 1), na.rm = TRUE), include.lowest = TRUE, labels = FALSE)

# Combine categories into a single factor for color mapping
x_short <- filter(x, past>0)
x_short$past_cat <- cut(x_short$past, breaks = quantile(x_short$past, probs = seq(0, 1, length.out = n_breaks + 1), na.rm = T), include.lowest = TRUE, labels = FALSE)

#Past housing burden
x_short$past_burden <- paste(x_short$past_cat, x_short$HBF_PFS_cat, sep = "-")

# Create a bivariate color scale (3x3 grid)
legend1 <- bi_legend(pal = "DkViolet2",
                    dim = 3,
                    xlab = " Risk ",
                    ylab = " HB",
                    size = 7)+
  theme(plot.margin = margin(0, 0, 0, 0),
        plot.background = element_blank(),  
        panel.background = element_blank())

# Create the choropleth map
past_burden_g <- ggplot() +
  geom_sf(data = x_short, aes(fill = past_burden), color = NA, size = 0.1, show.legend = FALSE) +
  bi_scale_fill(pal = "DkViolet2", dim = 3, , na.value = 'white') +
  geom_sf(data = regions, fill = NA, lwd = .1) +
  coord_sf() +
  theme_void() +
  theme(plot.tag = element_text(size = 11, face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 11),
        legend.position = "none",
        plot.margin = margin(5, 1, 5, 0)) +
  scale_y_continuous(limits = c(272048.5-(1505132), 3172577)) +
  labs(tag =' (B)') 


# Combine map and legend
f1 <- past_burden_g +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf), 
            fill = NA, color = "black", linewidth = .5) +
  annotation_custom(ggplotGrob(legend1), 
                    xmin = -2356069.5, xmax = -2356069.5 + ( (272048.5+1.5*(725132/12)) - (272048.5-(1505132)) ), 
                    ymin = 272048.5-(1505132), ymax = 272048.5+1.5*(725132/12)) +
  theme(plot.margin = margin(5, 1, 5, 0))

#Poverty
x_short$past_poverty <- paste(x_short$past_cat, x_short$P200_I_PFS_cat, sep = "-")
x_short$past_isol <- paste(x_short$past_cat, x_short$LIF_PFS_cat, sep = "-")

# Create a bivariate color scale (3x3 grid)
legend3 <- bi_legend(pal = "DkViolet2",
                     dim = 3,
                     xlab = " Risk ",
                     ylab = " IBPL", #Ind. below 200% Federal Poverty Line
                     size = 7)+
  theme(plot.margin = margin(0, 0, 0, 0),
        plot.background = element_blank(),  
        panel.background = element_blank())


# Create the choropleth map
past_poverty_g <- ggplot() +
  geom_sf(data = x_short, aes(fill = past_poverty), color = NA, size = 0.1, show.legend = FALSE) +
  bi_scale_fill(pal = "DkViolet2", dim = 3, , na.value = 'white') +
  geom_sf(data = regions, fill = NA, lwd = .1) +
  coord_sf() +
  theme_void() +
  theme(plot.tag = element_text(size = 11, face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 11),
        legend.position = "none",
        plot.margin = margin(5, 1, 5, 0)) +
  scale_y_continuous(limits = c(272048.5-(1505132), 3172577)) +
  labs(tag =' (A)') 

# Combine map and legend
f3 <- past_poverty_g +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf), 
            fill = NA, color = "black", linewidth = .5) +
  annotation_custom(ggplotGrob(legend3), 
                    xmin = -2356069.5, xmax = -2356069.5 + ( (272048.5+1.5*(725132/12)) - (272048.5-(1505132)) ), 
                    ymin = 272048.5-(1505132), ymax = 272048.5+1.5*(725132/12)) +
  theme(plot.margin = margin(5, 1, 5, 0))


#Linguistuc isolation
# Create a bivariate color scale (3x3 grid)
legend4 <- bi_legend(pal = "DkViolet2",
                     dim = 3,
                     xlab = " Risk ",
                     ylab = " LI",
                     size = 7) +
  theme(plot.margin = margin(0, 0, 0, 0),
        plot.background = element_blank(),  
        panel.background = element_blank())

# Create the choropleth map
past_isolation_g <- ggplot() +
  geom_sf(data = x_short, aes(fill = past_isol), color = NA, size = 0.1, show.legend = FALSE) +
  bi_scale_fill(pal = "DkViolet2", dim = 3, , na.value = 'white') +
  geom_sf(data = regions, fill = NA, lwd = .1) +
  coord_sf() +
  theme_void() +
  theme(plot.tag = element_text(size = 11, face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 11),
        legend.position = "none",
        plot.margin = margin(5, 1, 5, 0)) +
  scale_y_continuous(limits = c(272048.5-(1505132), 3172577)) +
  labs(tag =' (C)') 


# Combine map and legend
f4 <- past_isolation_g +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf), 
            fill = NA, color = "black", linewidth = .5) +
  annotation_custom(ggplotGrob(legend4), 
                    xmin = -2356069.5, xmax = -2356069.5 + ( (272048.5+1.5*(725132/12)) - (272048.5-(1505132)) ), 
                    ymin = 272048.5-(1505132), ymax = 272048.5+1.5*(725132/12)) +
  theme(plot.margin = margin(5, 1, 5, 0))

#Change
x_df <- x %>%
  st_drop_geometry() %>% 
  mutate(across(c(chng_cn, chng_hd, chng_mr), ~ as.numeric(as.character(.)))) %>%
  rowwise() %>%
  mutate(change_mean = mean(c_across(c(chng_cn, chng_hd, chng_mr)), na.rm = TRUE)) %>%
  ungroup()

x <- x[, -139] %>% 
  left_join(x_df[,c(1, 138)])
x_change <- filter(x, change_mean>1)

x_change$change_cat <- cut(x_change$change_mean, breaks = quantile(x_change$change_mean, probs = seq(0, 1, length.out = n_breaks + 1), na.rm = T), include.lowest = TRUE, labels = FALSE)

x_change$fut_burden <- paste(x_change$change_cat, x_change$HBF_PFS_cat, sep = "-")
x_change$fut_poverty <- paste(x_change$change_cat, x_change$P200_I_PFS_cat, sep = "-")
x_change$fut_isolation <- paste(x_change$change_cat, x_change$LIF_PFS_cat, sep = "-")

#Housing burden
# Create a bivariate color scale (3x3 grid)
legend2 <- bi_legend(pal = "DkViolet2",
                    dim = 3,
                    xlab = " Risk inc.",
                    ylab = " HB",
                    size = 7)+
  theme(plot.margin = margin(0, 0, 0, 0),
        plot.background = element_blank(),  
        panel.background = element_blank())

# Create the choropleth map
fut_burden_g <- ggplot() +
  geom_sf(data = x_change, aes(fill = fut_burden), color = NA, size = 0.1, show.legend = FALSE) +
  bi_scale_fill(pal = "DkViolet2", dim = 3, , na.value = 'white') +
  geom_sf(data = regions, fill = NA, lwd = .1) +
  coord_sf() +
  theme_void() +
  theme(plot.tag = element_text(size = 11, face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 11),
        legend.position = "none",
        plot.margin = margin(5, 1, 5, 0)) +
  scale_y_continuous(limits = c(272048.5-(1505132), 3172577)) +
  labs(tag =' (E)') 


# Combine map and legend
f2 <- fut_burden_g +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf), 
            fill = NA, color = "black", linewidth = .5) +
  annotation_custom(ggplotGrob(legend2), 
                    xmin = -2356069.5, xmax = -2356069.5 + ( (272048.5+1.5*(725132/12)) - (272048.5-(1505132)) ), 
                    ymin = 272048.5-(1505132), ymax = 272048.5+1.5*(725132/12)) +
  theme(plot.margin = margin(5, 1, 5, 0))


#Change in poverty
# Create a bivariate color scale (3x3 grid)
legend5 <- bi_legend(pal = "DkViolet2",
                     dim = 3,
                     xlab = " Risk inc.",
                     ylab = " IBPL",
                     size = 7)+
  theme(plot.margin = margin(0, 0, 0, 0),
        plot.background = element_blank(),  
        panel.background = element_blank())

# Create the choropleth map
fut_poverty_g <- ggplot() +
  geom_sf(data = x_change, aes(fill = fut_poverty), color = NA, size = 0.1, show.legend = FALSE) +
  bi_scale_fill(pal = "DkViolet2", dim = 3, , na.value = 'white') +
  geom_sf(data = regions, fill = NA, lwd = .1) +
  coord_sf() +
  theme_void() +
  theme(plot.tag = element_text(size = 11, face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 11),
        legend.position = "none",
        plot.margin = margin(5, 1, 5, 0)) +
  scale_y_continuous(limits = c(272048.5-(1505132), 3172577)) +
  labs(tag =' (D)') 


# Combine map and legend
f5 <- fut_poverty_g +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf), 
            fill = NA, color = "black", linewidth = .5) +
  annotation_custom(ggplotGrob(legend5), 
                    xmin = -2356069.5, xmax = -2356069.5 + ( (272048.5+1.5*(725132/12)) - (272048.5-(1505132)) ), 
                    ymin = 272048.5-(1505132), ymax = 272048.5+1.5*(725132/12)) +
  theme(plot.margin = margin(5, 1, 5, 0))

#Change in lingusitic isolation
# Create a bivariate color scale (3x3 grid)
legend6 <- bi_legend(pal = "DkViolet2",
                     dim = 3,
                     xlab = " Risk inc.",
                     ylab = " LI", # households in linguistic isolation 
                     size = 7)+
  theme(plot.margin = margin(0, 0, 0, 0),
        plot.background = element_blank(),  
        panel.background = element_blank())

# Create the choropleth map
fut_isol_g <- ggplot() +
  geom_sf(data = x_change, aes(fill = fut_isolation), color = NA, size = 0.1, show.legend = FALSE) +
  bi_scale_fill(pal = "DkViolet2", dim = 3, , na.value = 'white') +
  geom_sf(data = regions, fill = NA, lwd = .1) +
  coord_sf() +
  theme_void() +
  theme(plot.tag = element_text(size = 11, face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 11),
        legend.position = "none",
        plot.margin = margin(5, 1, 5, 0)) +
  scale_y_continuous(limits = c(272048.5-(1505132), 3172577)) +
  labs(tag =' (F)') 


# Combine map and legend
f6 <- fut_isol_g +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf), 
            fill = NA, color = "black", linewidth = .5) +
  annotation_custom(ggplotGrob(legend6), 
                    xmin = -2356069.5, xmax = -2356069.5 + ( (272048.5+1.5*(725132/12)) - (272048.5-(1505132)) ), 
                    ymin = 272048.5-(1505132), ymax = 272048.5+1.5*(725132/12)) +
  theme(plot.margin = margin(5, 1, 5, 0))



fig <- ggpubr::ggarrange(ggarrange(f3, f1, f4, ncol = 3, nrow = 1), 
                         ggarrange(f5, f2, f6,  ncol = 3, nrow = 1),
                         ncol = 1,
                         nrow = 2)
ggsave(plot = fig, 'Figures/Fig_8.jpeg', width = 6.75, height = 5, dpi = 600)
ggsave(plot = fig, 'Figures/Fig_8.pdf', width = 6.75, height = 5, dpi = 600)

#Summary stats
# Current housing burden
hr <- filter(x_short, past_burden %in% '3-3')
summary(hr$HBF_PFS)

hr_sum <- hr %>%
  st_drop_geometry() %>%
  group_by(region) %>%
  summarise(past = n())

ctys <- x%>%
  st_drop_geometry() %>%
  group_by(region) %>%
  summarise(total_ctys = n())

hr_sum <- left_join(hr_sum, ctys)
hr_sum %>%
  mutate(perc_risk_burden = 100*past/total_ctys)
high_burd <- filter(x_short, HBF_PFS_cat %in% '3')
high_burd <- high_burd %>%
  st_drop_geometry() %>%
  group_by(region) %>%
  summarise(burden_ctys = n())
high_burd <- left_join(high_burd, ctys)
high_burd  %>%
  mutate(perc_burden = 100*burden_ctys/total_ctys)

# Current pvoerty
hp <- filter(x_short, past_poverty %in% '3-3')
hp_sum <- hp %>%
  st_drop_geometry() %>%
  group_by(region) %>%
  summarise(past = n())

hp_sum <- left_join(hp_sum, ctys)
hp_sum %>%
  mutate(perc_risk_poverty = 100*past/total_ctys)
high_poverty <- filter(x_short, P200_I_PFS_cat %in% '3')
high_poverty <- high_poverty %>%
  st_drop_geometry() %>%
  group_by(region) %>%
  summarise(poverty_ctys = n())
high_poverty <- left_join(high_poverty, ctys)
high_poverty  %>%
  mutate(perc_poverty = 100*poverty_ctys/total_ctys)

# Current linguistic isolation
hi <- filter(x_short, past_isol %in% '3-3')
hi_sum <- hi %>%
  st_drop_geometry() %>%
  group_by(region) %>%
  summarise(past = n())

hi_sum <- left_join(hi_sum, ctys)
hi_sum %>%
  mutate(perc_risk_isol = 100*past/total_ctys)
high_isol <- filter(x_short, LIF_PFS_cat %in% '3')
high_isol <- high_isol %>%
  st_drop_geometry() %>%
  group_by(region) %>%
  summarise(isol_ctys = n())
high_isol <- left_join(high_isol, ctys)
high_isol  %>%
  mutate(perc_isol = 100*isol_ctys/total_ctys)

#Increase in risk
#Housing burden
change_n <- x_change  %>%
  st_drop_geometry() %>%
  distinct(GEOID10, .keep_all = TRUE) %>% 
  group_by(region) %>%
  summarise(change = n())
hc <- filter(x_change, fut_burden %in% '3-3')

hc_sum <- hc %>%
  st_drop_geometry() %>%
  group_by(region) %>%
  summarise(fut = n())

hc_sum <- left_join(hc_sum, ctys)
hc_sum %>%
  mutate(perc_fut_burden = 100*fut/total_ctys)
hc_sum <- left_join(hc_sum, change_n)
hc_sum %>%
  mutate(perc_fut_burden_ch = 100*fut/change)

high_burd_change <- filter(x_change, HBF_PFS_cat %in% '3')
high_burd_change <- high_burd_change %>%
  st_drop_geometry() %>%
  group_by(region) %>%
  summarise(burden_ctys_change = n())
high_burd_change <- left_join(high_burd_change, ctys)
high_burd_change  %>%
  mutate(perc_burden_change = 100*burden_ctys_change/total_ctys)

#Poverty
hcp <- filter(x_change, fut_poverty %in% '3-3')

hcp_sum <- hcp %>%
  st_drop_geometry() %>%
  group_by(region) %>%
  summarise(fut = n())

hcp_sum <- left_join(hcp_sum, ctys)
hcp_sum %>%
  mutate(perc_fut_poverty = 100*fut/total_ctys)
high_poverty_change <- filter(x_change, P200_I_PFS_cat %in% '3')
high_poverty_change <- high_poverty_change %>%
  st_drop_geometry() %>%
  group_by(region) %>%
  summarise(poverty_ctys_change = n())
high_poverty_change <- left_join(high_poverty_change, ctys)
high_poverty_change  %>%
  mutate(perc_poverty_change = 100*poverty_ctys_change/total_ctys)

#Linguistivc isolation
hci <- filter(x_change, fut_isolation %in% '3-3')

hci_sum <- hci %>%
  st_drop_geometry() %>%
  group_by(region) %>%
  summarise(fut = n())

hci_sum <- left_join(hci_sum, ctys)
hci_sum %>%
  mutate(perc_fut_isolation = 100*fut/total_ctys)
high_isol_change <- filter(x_change, LIF_PFS_cat %in% '3')
high_isol_change <- high_isol_change %>%
  st_drop_geometry() %>%
  group_by(region) %>%
  summarise(isol_ctys_change = n())
high_isol_change <- left_join(high_isol_change, ctys)
high_isol_change  %>%
  mutate(perc_isol_change = 100*isol_ctys_change/total_ctys)

#All
tot_c <- filter(x_change, fut_isolation %in% '3-3' & fut_poverty %in% '3-3' & fut_isolation %in% '3-3')
tot_c_sum <- tot_c  %>%
  st_drop_geometry() %>%
  distinct(GEOID10, .keep_all = TRUE) %>% 
  group_by(region) %>%
  summarise(fut = n())

tot_c_sum <- left_join(tot_c_sum, ctys)
tot_c_sum %>%
  mutate(perc_fut_bad = 100*fut/total_ctys)
high_bad_change <- filter(x_change, LIF_PFS_cat %in% '3', P200_I_PFS_cat %in% '3' & HBF_PFS_cat %in% '3')
high_bad_change <- high_bad_change %>%
  st_drop_geometry() %>%
  distinct(GEOID10, .keep_all = TRUE) %>% 
  group_by(region) %>%
  summarise(bad_ctys_change = n())
high_bad_change <- left_join(high_bad_change, change_n)
high_bad_change  %>%
  mutate(perc_bad_change = 100*bad_ctys_change/change)
(836+1668+2361)/(7489+21892+11221)
#poverty or burden
tot_c <- filter(x_change, fut_burden %in% '3-3' | fut_poverty %in% '3-3')
tot_c_sum <- tot_c  %>%
  st_drop_geometry() %>%
  distinct(GEOID10, .keep_all = TRUE) %>% 
  group_by(region) %>%
  summarise(fut = n())

tot_c_sum <- left_join(tot_c_sum, change_n)
tot_c_sum %>%
  mutate(perc_fut_bad = 100*fut/change)
high_bad_change <- filter(x_change, P200_I_PFS_cat %in% '3' | HBF_PFS_cat %in% '3')
high_bad_change <- high_bad_change %>%
  st_drop_geometry() %>%
  distinct(GEOID10, .keep_all = TRUE) %>% 
  group_by(region) %>%
  summarise(bad_ctys_change = n())
high_bad_change <- left_join(high_bad_change, change_n)
high_bad_change  %>%
  mutate(perc_bad_change = 100*bad_ctys_change/change)

#Pov or burden current

tot_c <- filter(x_short, past_poverty %in% '3-3' | past_burden %in% '3-3')
tot_c_sum <- tot_c  %>%
  st_drop_geometry() %>%
  distinct(GEOID10, .keep_all = TRUE) %>% 
  group_by(region) %>%
  summarise(fut = n())

tot_c_sum <- left_join(tot_c_sum, ctys)
tot_c_sum %>%
  mutate(perc_fut_bad = 100*fut/total_ctys)
high_bad_change <- filter(x_short, P200_I_PFS_cat %in% '3' | HBF_PFS_cat %in% '3')
high_bad_change <- high_bad_change %>%
  st_drop_geometry() %>%
  distinct(GEOID10, .keep_all = TRUE) %>% 
  group_by(region) %>%
  summarise(bad_ctys_change = n())
high_bad_change <- left_join(high_bad_change, ctys)
high_bad_change  %>%
  mutate(perc_bad_change = 100*bad_ctys_change/total_ctys)
(2693+9575+5361)/(7489+21892+11221)

#Combo2
tot_c <- filter(x_change, fut_isolation %in% '3-3' & fut_poverty %in% '3-3' | fut_isolation %in% '3-3')

tot_c_sum <- tot_c  %>%
  st_drop_geometry() %>%
  distinct(GEOID10, .keep_all = TRUE) %>% 
  group_by(region) %>%
  summarise(fut = n())

tot_c_sum <- left_join(tot_c_sum, change_n)
tot_c_sum %>%
  mutate(perc_fut_bad = 100*fut/change)

high_bad_change <- filter(x_change, LIF_PFS_cat %in% '3'& (P200_I_PFS_cat %in% '3' | HBF_PFS_cat %in% '3'))
high_bad_change <- high_bad_change %>%
  st_drop_geometry() %>%
  distinct(GEOID10, .keep_all = TRUE) %>% 
  group_by(region) %>%
  summarise(bad_ctys_change = n())
high_bad_change <- left_join(high_bad_change, change_n)
high_bad_change  %>%
  mutate(perc_bad_change = 100*bad_ctys_change/change)

high_bad_change <- filter(x_change, (P200_I_PFS_cat %in% '3' | HBF_PFS_cat %in% '3'))
high_bad_change <- high_bad_change %>%
  st_drop_geometry() %>%
  distinct(GEOID10, .keep_all = TRUE) %>% 
  group_by(region) %>%
  summarise(bad_ctys_change = n())
high_bad_change <- left_join(high_bad_change, change_n)
high_bad_change  %>%
  mutate(perc_bad_change = 100*bad_ctys_change/change)

tot_c <- filter(x_short, past_poverty %in% '3-3' | past_burden %in% '3-3' & past_isol %in% '3-3')
tot_c_sum <- tot_c  %>%
  st_drop_geometry() %>%
  distinct(GEOID10, .keep_all = TRUE) %>% 
  group_by(region) %>%
  summarise(fut = n())

tot_c_sum <- left_join(tot_c_sum, change_n)
tot_c_sum %>%
  mutate(perc_fut_bad = 100*fut/change)
high_bad_change <- filter(x_short, LIF_PFS_cat %in% '3'| P200_I_PFS_cat %in% '3' & HBF_PFS_cat %in% '3')
high_bad_change <- high_bad_change %>%
  st_drop_geometry() %>%
  distinct(GEOID10, .keep_all = TRUE) %>% 
  group_by(region) %>%
  summarise(bad_ctys_change = n())
high_bad_change <- left_join(high_bad_change, ctys)
high_bad_change  %>%
  mutate(perc_bad_change = 100*bad_ctys_change/total_ctys)


